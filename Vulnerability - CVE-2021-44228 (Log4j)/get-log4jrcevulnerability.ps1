<#
Name: get-log4jrcevulnerability.ps1
Version: 0.2.1 (21st December 2021)
Author: Prejay Shah (Doherty Associates)
Thanks: Christopher Bledsoe (IPM Computers) for some bugfixes, 
        Robby Swartenbroekx (b-Inside) for some ideas, 
        Arctic Wolf for coming up with a way to detect patched files
Purpose: Detection of jar files vulnerable to the "Log4Shell" log4j RCE vulnerability (CVE-2021-44228)
Originally Utilizing JNDILookup detection method posted to https://gist.github.com/Neo23x0/e4c8b03ff8cdf1fa63b7d15db6e3860b with some slight modifications to make it more RMM friendly
Log4J 2.15 fixed the original Log4Shell CVE, but was suspectable to CVE-2021-44228 which was elevated to an RCE vulnerability and fixed in Log4J 2.16
I then adopted a method presented to me on behlaf of ArcticWolf of extractind the JAR file to corroborate whether the Log4J 2.16 changes have been applied to a JAR file.
Robby S then suggested an amendment to track the fix in 2.17 for CVE-2021-45105 that was introuduced in Log4J 2.16.

NOTE: Not currently compatible with Powershlel 2.0
Have excluded files within windows\system32\spool\drivers from being scanned due to access denied issues disrupting the output. 

0.1 Initial Release
0.1.1 Adeed Dedupe to Vulnerable .JAR Listings
0.1.2 Public Release
0.1.3 Found that use of -force isn't working for all scans. Have added a non forced mode to see what outputs can be obtained
0.1.4 Experimenting with Unicode/Robocopy to bypass 260 character file path limit / access denied errors
0.1.5 added support for pseverything module
0.1.5.1 changed detection to be module based rather than command based
0.1.5.2 Cleaned up Output
0.1.6 Have revamped order to PSEverything, Robocopy, GCI
0.1.6.1 Fixed Typo, Modification for N-Central AMP Output of file names when robocopy is utilized
0.1.7 Some bugfixes courtesy of Christopher Bledsoe (IPM Computers). Who knew cinaccessible cloud only JAR files would be a thing?
        won't try checking an empty file path
        should ignore those "placeholder.jar" files in things like dropbox cache
        it uses "|" for the delimiter when reading the CSV/txt file created, so any file paths with "," in them should not get unintentionally split
0.1.7.1 Excluding spool\drivers jar files from being scanned
0.1.7.2 Updated gci to use -filter and -file rather than -include after finding it to be much more performant
0.1.8 Fix for Everything/gci compatibility, Update for Log4j 2.16 update
0.1.8.1 Improved Try/Catch methodology for when Everything search Fails. Thanks to Robby Swartenbroekx (b-Inside) for the assist.
0.1.8.2 Made robocopy window hidden by request
0.1.8.3 Improved Vulnerable File Output for RMM
0.1.9 Expanded Search Criteria to all fixed drives on a device, and added update for Log4j 2.17 Compatibility (Thx to Robby S)
0.2 Separated detection of Log4j 2.16 PAtched and 2.17 Patched States
0.2.1 Adding better output for when Everything fails to scan via RMM PS wrapping
#>

$Version = "0.2.1" # 21st December 2021
Write-Host "`nget-log4jrcevulnerability $version" -foregroundcolor Green
$robocopycsv = $null
$log4jvulnerablefiles = $null
$robocopycsvfile = "$env:temp\log4jfilescan.csv"

try {
  if (get-module -listavailable | where-object {$_.name -like 'PSEverything'}) {
      Write-Host "The almighty PSEverything module's Search-Everything command was found.`nDoing a new scan because we can..." -ForegroundColor Yellow
      $log4jfiles = $null
      $log4jfilescan = $null
      $StopWatch = [system.diagnostics.stopwatch]::startNew()
      $log4jfilescan = search-everything -global -extension jar
      $StopWatch.stop()
      $Timetaken = $StopWatch.elapsed.totalseconds
      if ($log4jfilescan -ne $null) {
          Write-host "See? That only took $([math]::Round($($Timetaken),2)) seconds to scan all Fixed NTFS Drives for .jar files!" -foregroundcolor Green
          $log4jfilenames = $log4jfilescan
      }
      else {
        $StopWatch.stop()
        Write-Host $($StopWatch.elapsed.totalseconds) -ForegroundColor Red
        Write-Host "Something went wrong with calling PSEverything, lets fallback to the next scan method." -ForegroundColor Yellow
        Throw        
      }
  }
  else {
      # Write-Host "Something went wrong with calling PSEverything, lets fallback to the next scan method." -ForegroundColor Yellow
      Throw
  }
}
catch {
  #Run when PSEverything isn't found or it gave an error
  $Drives = ([System.IO.DriveInfo]::getdrives() | Where-Object {$_.DriveType -eq 'Fixed'}).Name
  if (test-path $robocopycsvfile) {
    remove-item $robocopycsvfile -force
  }
  try {
    Write-Host "Attempting to use Robocopy to scan for JAR files on all Fixed Drives.." -ForegroundColor Yellow
      foreach ($drive in $drives) {
        $robocopyexitcode = (start-process robocopy  -argumentlist "$drive c:\DOESNOTEXIST *.jar /S /XJ /L /FP /NS /NC /NDL /NJH /NJS /r:0 /w:0 /LOG+:$env:temp\log4jfilescan.csv" -WindowStyle hidden -wait).exitcode
      }
      if ($? -eq $True) {
          $robocopycsv = $true
          $log4jfilescan = import-csv $robocopycsvfile -header FilePath -delimiter "|"       
          $log4jfilenames = $log4jfilescan
      }
  }
  catch {
      Write-Host "WARNING: Robocopy Scan failed. Falling back to GCI.." -ForegroundColor Yellow
      foreach ($drive in $drives) {
        $log4jfilescan = get-childitem $drive -file -filter *.jar -rec -force -ea 0
      }
      if ($? -eq $true) {
          $log4jfilenames = ($log4jfilescan).fullname 
      }
      else {
          $log4jfiles = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - ERROR: Unable to scan files"
          $log4jvulnerable = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - ERROR: Unable to scan files"
          $log4jvulnerablefilecount = '-1'
          Write-Host $log4jfiles -ForegroundColor Red
          Exit 1
      }
  }
}


if ($log4jfilescan -eq $null) {
    $log4jfiles = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') OK - No JAR Files were found on this device"
    $log4jvulnerable = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') OK - No JAR Files were found on this device"
    $log4jvulnerablefilecount = '0'
    Write-Host "$log4jvulnerable" -ForegroundColor Green
}
else {
    Write-Host "Determining whether any of the $(($log4jfilenames).count) found .jar files are potentially vulnerable to CVE-2021-44228 (Log4Shell) due to being capable of JNDI lookups..." -ForegroundColor Yellow
    if ($log4jfilescan -eq $null) {
      $log4jpotentiallyvulnerablefiles = $null
    } elseif ($log4jfilescan -ne $null) {
      if ($robocopycsv -eq $true) {
        $log4jpotentiallyvulnerablefiles = $log4jfilescan | foreach-object {
          if (($_.FilePath -ne $null) -and ($_.FilePath -ne "")) {
            if (($_.FilePath -notmatch "placeholder.jar") -and ($_.FilePath -notmatch "spool\\drivers")) {
              #write-host "CHECKING : " $_.FilePath -ForegroundColor Yellow
              select-string "JndiLookup.class" $_.FilePath
            }
          }
        } | select-object -exp Path | sort-object -unique
      }
      else {
        $log4jpotentiallyvulnerablefiles = $log4jfilescan | foreach-object {
          if (($_ -ne $null) -and ($_ -ne "")) {
            if ($_ -notmatch "placeholder.jar") {
              #write-host "CHECKING : " $_ -ForegroundColor Yellow
              select-string "JndiLookup.class" $_
            }
          }
        } | select-object -exp Path | sort-object -unique
      }
    }
    $log4jpotentiallyvulnerablefilecount = ($log4jpotentiallyvulnerablefiles).count
    if ($log4jpotentiallyvulnerablefiles -eq $null) {
      $log4jvulnerable = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') OK - 0 Vulnerable JAR files were found"
      write-host "Log4J CVE-2021-44228 Potentially Vulnerable Files:`n$log4jvulnerable" -ForegroundColor Green
    } 
    elseif ($log4jpotentiallyvulnerablefiles -ne $null) {
      Write-Host "$log4jpotentiallyvulnerablefilecount Potentially Vulnerable JAR file(s) were found:" -foregroundcolor Red
      $log4jpotentiallyvulnerablefiles.Foreach({ Write-Host $_ -ForegroundColor Red })
      Write-Host "`nChecking the $($log4jpotentiallyvulnerablefiles.count) potentially vulnerable files for an actual vulnerability now that Log4j 2.17 has been released..." -foregroundcolor Yellow

      Add-Type -AssemblyName System.IO.Compression.FileSystem
      Foreach ($log4jpotentiallyvulnerablefile in $log4jpotentiallyvulnerablefiles) {
        $jartoscan = [io.compression.zipfile]::OpenRead($log4jpotentiallyvulnerablefile)
        $potentiallyvulnerable = $false
        $patchedjar = $false
          foreach ($Entry in $jartoscan.Entries) {
            if ($Entry.Name -eq "JndiLookup.class") {
              $potentiallyvulnerable = $true
            }
            elseif ($Entry.Name -eq "JndiManager.class") {
              try {
                $stream = $Entry.Open()
                $reader = New-Object IO.StreamReader($stream)
                $jarattributes = $reader.ReadToEnd()
                # Apache Log4j 2.17 Fix. (Thx to Robby S - b-Inside)
                $CVE202145105patchedjar = $jarattributes | Select-String -Pattern "isJndiContextSelectorEnabled" -Quiet
                # Apache Log4j 2.15/2.16 Fix
                $CVE202144228patchedjar = $jarattributes | Select-String -Pattern "allowedJndiProtocols" -Quiet

              }
              catch {
                Write-Output $_
                Write-Output "Result: ERROR"
                exit 1
              }
              finally {
                # Need the checks since we don't know where the try statements might fail
                if ($reader) {
                  $reader.Close()
                }
                if ($stream) {
                  $stream.Close()
                }
                if ($jar) {
                  $jartoscan.Dispose()
                }
              }
            }
          }
          if ($potentiallyvulnerable -and $CVE202145105patchedjar) {
            $CVE202145105patchedjarfiles += @($log4jpotentiallyvulnerablefile)
            Write-Host "$($log4jpotentiallyvulnerablefile | split-path -leaf) has been fully patched to the current standard (Log4J 2.17)" -ForegroundColor Green            
          }
          else {
            $log4jvulnerablefiles += @($log4jpotentiallyvulnerablefile)
            #  which addresses all 3 known Log4Shell related Vulnerabilities: CVE-2021-44228, CVE-2021-45046, CVE-2021-45105
            if ($potentiallyvulnerable -and $CVE202144228patchedjar) {
              $CVE202144228patchedjarfiles += @($log4jpotentiallyvulnerablefile)
              Write-Host "$($log4jpotentiallyvulnerablefile | split-path -leaf) has been patched to Log4j 2.15/2.16 which addresses `Log4Shell` (CVE-2021-44228), however is still vulnerable to CVE-2021-45105" -ForegroundColor Red
            }
          }
    }
    $log4jvulnerablefiles =  $log4jvulnerablefiles | sort-object -Unique
    $log4jvulnerablefilecount = ($log4jvulnerablefiles).count
    if ($log4jvulnerablefilecount -ge '1') {
      Write-Host "`n$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') WARNING - $log4jvulnerablefilecount Vulnerable File(s) found:" -foregroundcolor Red
      $log4jvulnerablefiles.Foreach({ Write-Host $_ -ForegroundColor Red })
      Write-Host "Recommend that these JAR Files be updated to utilize Log4J 2.17 at the earliest opportunity" -ForegroundColor Cyan
      $log4jvulnerable = $log4jvulnerablefiles -join '<br>'
    }
    else {
      $log4jvulnerable = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') OK - 0 Vulnerable JAR files were found"
      write-host "$log4jvulnerable" -ForegroundColor Green      
    }
  }
}

if ($robocopycsv -eq $true) {
    $log4jfiles = get-content $robocopycsvfile -readcount 0 | ForEach-Object{$_ -join '<br>'}
    start-sleep 5
    remove-item $robocopycsvfile -force
}
else {
    $log4jfiles = $log4jfilenames -join '<br>'
}